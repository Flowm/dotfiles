########################################################################
# Host detection
########################################################################

MC_OS=`uname`
case "$MC_OS" in
	Linux)
		MC_LINUX=1
		MC_GNU_USERLAND=1
		MC_HOST=`uname -n`
		MC_PLATFORM=`uname -m`
		case "$MC_PLATFORM" in
			armv6l)
				MC_SLOWSYS=1
				;;
		esac
		MC_DIST_ID=$(grep ^ID= /etc/*-release | cut -d= -f2)
		MC_DIST_ID_LIKE=$(grep ^ID_LIKE= /etc/*-release | cut -d= -f2)
		;;
	Darwin)
		MC_OSX=1
		MC_HOST=`hostname -s`
		;;
	CYGWIN*)
		MC_CYGWIN=1
		MC_HOST=`uname -n`
		;;
	OpenBSD)
		MC_OPENBSD=1
		MC_HOST=`hostname -s`
		;;
	*)
		MC_HOST=`echo $HOSTNAME | sed "s/\([a-z]*\)\..*/\1/"`
		;;
esac

MC_USER=`whoami`
case "$MC_USER" in
	fmaurach)
		MC_WORK=1
		;;
	flow)
		MC_PRIV=1
		;;
esac

# SHELL
if [ -n "$ZSH_VERSION" ]; then
	MC_SHELL="zsh"
	MC_ZSH=1
elif [ -n "$BASH_VERSION" ]; then
	MC_SHELL="bash"
	MC_BASH=1
else
	MC_SHELL=$(ps h -p $$ -o args='' | cut -f1 -d' ')
fi

########################################################################
# ENV
########################################################################

export EDITOR="vim"

# Add $HOME/bin and all subdirs to the path
if [ -d "$HOME/bin" ]; then
	for d in "$HOME"/bin/*; do
		if [ -d "$d" ]; then
			PATH="${d%%/}:$PATH"
		fi
	done
	PATH="$HOME/bin:$PATH"
fi

# Locale settings. Force en_US.UTF-8 instead of smart detection for now
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
#[ -z "$LANG" ] && [ "$(locale -a | grep en_US.UTF-8)" ] && export LANG="en_US.UTF-8"

if [ -n "$MC_OSX" ] && [ "$TERM_PROGRAM" = "iTerm.app" ]; then
	export LC_TERM="iterm"
fi

########################################################################
# SSH Agent
########################################################################

# Ensure ssh-agent is running
if [ -e $HOME/.myc-sagent ] && ! pgrep -u $USER ssh-agent >/dev/null; then
	eval $(ssh-agent -s)
	ssh-add
fi

# Fix symlink for tmux
if [ -S "$SSH_AUTH_SOCK" ] && [ ! -h "$SSH_AUTH_SOCK" ]; then
	ln -sf "$SSH_AUTH_SOCK" ~/.ssh/ssh_auth_sock
fi
export SSH_AUTH_SOCK=~/.ssh/ssh_auth_sock

########################################################################
# History
########################################################################

# Long history
export HISTSIZE=100000
export SAVEHIST=$HISTSIZE

# Additionally log history to file
if [ -z "$MC_SLOWSYS" ]; then
	export MC_HISTFILE=~/.myconf/history/$(date +%Y)_${MC_HOST}_eternal_history
	(umask 077; touch $MC_HISTFILE)

	if [ "$MC_BASH" ]; then
		_log_hist() {
			if [ -w "$MC_HISTFILE" ]; then
				echo -e "$(date +%F-%H-%M-%S)\t${MC_HOST}\t${MC_SHELL}\t$$\t${MC_USER}\t$(history 1 | sed 's/^ *[0-9]* *//')" >> $MC_HISTFILE
			fi
		}
		PROMPT_COMMAND="${PROMPT_COMMAND:+$PROMPT_COMMAND ; } _log_hist"
	fi
	if [ "$MC_ZSH" ]; then
		preexec() {
			if [ -w "$MC_HISTFILE" ]; then
				echo -e "$(date +%F-%H-%M-%S)\t${MC_HOST}\t${MC_SHELL}\t$$\t${MC_USER}\t${1}" >> $MC_HISTFILE
			fi
		}
	fi
fi

########################################################################
# Program specific
########################################################################
TIGRESS_HOME="/opt/tigress-unstable"
if [ -d "$TIGRESS_HOME" ]; then
	export TIGRESS_HOME
	export PATH=$PATH:$TIGRESS_HOME
fi

TEXBIN_PATH="/Library/TeX/texbin"
if [ -d "$TEXBIN_PATH" ]; then
	export PATH=$PATH:$TEXBIN_PATH
fi
