#!/usr/bin/env bash
set -eu

usage() {
	echo -e "Usage: $0 [-puib] -c [opts]" 1>&2
	echo -e "\t-p Print clone command" 1>&2
	echo -e "\t-u Update config" 1>&2
	echo -e "\t-s Update submodules" 1>&2
	echo -e "\t-i Install config" 1>&2
	echo -e "\t-b Install base packages" 1>&2
    echo -e "\t-c Config opts (extra, tmux)" 1>&2
	exit 1
}

while getopts ":pusibc:dh" opt; do
	case $opt in
		p)
			PRINT=true;
			;;
		u)
			UPDATE=true;
			;;
		s)
			SUBUP=true;
			;;
		i)
			INST=true;
			;;
		b)
			BASE=true;
			;;
		c)
			CONFOPTS=$OPTARG;
			;;
		d)
			DEBUG=true; set -x
			;;
		*)
			usage
			;;
	esac
done
shift $(($OPTIND - 1))

conf_dir="$HOME/.myconf"
conf_bin="$conf_dir/bin"
conf_home="$conf_dir/home"
conf_hist="$conf_dir/history"
conf_tools="$conf_dir/tools"

if [ ${PRINT:-} ]; then
	cat ${conf_dir}/data/instdb/myconf
fi

if [ ${UPDATE:-} ]; then
	cd ${conf_dir} && git pull --ff-only
fi

if [ ${SUBUP:-} ]; then
	cd ${conf_dir} && git submodule update --init --recursive
fi

if [ ${INST:-} ]; then
	echo "Install config"
	${conf_tools}/config-install.sh
fi

if [ ${BASE:-} ]; then
	echo "Install base software"
	sudo ${conf_dir}/data/instdb/apt-base
fi

if [ ${CONFOPTS:-} ]; then
    if [ "$CONFOPTS" == "extra" ]; then
        echo "Install extra config"
        git -C "$conf_home/.ssh" pull --ff-only || git clone flow@mauracher.eu:/home/flow/.git/.ssh.git "$conf_home/.ssh"
    elif [ "$CONFOPTS" == "tmux" ]; then
        echo "Configure tmux autoattach"
        touch ~/.myc-tmuxa
    fi
fi
