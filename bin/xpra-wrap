#!/usr/local/bin/bash
set -eu

usage() { echo "Usage: $0 [-sadh] xterm,tnt,firefox,thunderbird" 1>&2; exit 1; }

mode=attach
host="ws1.g"
declare -A display
display["xterm"]=45
display["tnt"]=46
display["firefox"]=47
display["thunderbird"]=48
display["xchat"]=49

while getopts ":sadh:" o; do
    case $o in
        s)
			mode=start;
			;;
        a)
			mode=attach;
			;;
        h)
			host=$OPTARG;
			;;
        d)
			debug=true; set -x
			;;
        *)
			usage
			;;
	esac
done
shift $(($OPTIND - 1))

if [ "$#" -ne 1 ]; then
	usage
fi
programm=$1
port=50
if [ ${display["$programm"]+abc} ]; then
	port=${display["$programm"]}
elif [ ${display["${programm##*/}"]+abc} ]; then
	port=${display["${programm##*/}"]}
else
	usage
fi

echo "xpra $mode $host:$port $programm"
case "$mode" in
	"start")
		ssh $host "xpra start :$port --start-child=$programm --exit-with-children"
		;;
	"attach")
		xpra attach ssh:$host:$port --encoding=png
		;;
esac

exit
